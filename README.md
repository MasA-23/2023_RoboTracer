# 2023_RoboTracer
## 1.概要
　この機体は，ロボトレース競技に参加するためにサークル標準機を改良したロボットです．ロボトレを始めてから1年が経過したため，今までの改良をまとめようと思います．また，改良内容の言語化による問題点の明確化やサークル内での情報共有も目的としています．
 
## 2.ディレクトリ構造

## 3.開発環境
 - Visual Studio Code

 - Fusion360

 - Eagle

## 4.機体説明
<p align="center">
 <img src="https://github.com/MasA-23/2023_RoboTracer/assets/147514546/6678fec6-45e2-4e66-b0d3-dd4fd7b67914" width="500px">
</p>

- 機体名 : Savoia S.21M


- スペック
  - L×W×H[mm] : 155x111x80
  - 重量[g] : 700
  - タイヤ径[mm] : 52
  - 最高速度[m/s] : 2.9
  - 最高加速度[m/s^2] : 4


- 構成要素
  - マイコンボード : Raspberry Pi Pico
  - アクチュエータ : PKE243A-L
  - IMU : MPU-6050
  - ラインセンサ : LBR-127HLD
  - ADコンバータ : MCP3208

    
## 5.改良点
- ラインセンサ

  　Raspberry Pi Picoには，ユーザが使えるADCが3つしかありません．そのため，12bitの外付けADコンバータによるADCの増設をしました．ラズピコの2チャンネル+ADコンバータの8チャンネルを使用し，計10個のラインセンサを使えるようにしました．
  <p align="center">
   <img src="https://github.com/MasA-23/2023_RoboTracer/assets/147514546/81f3ebca-04ac-492f-b433-5287070fb427" width="500px">
  </p>



- モータref電圧の上昇

  　ステッピングモータは電圧をかけることでトルクと最高速度が上がるため，モタドラへのref電圧を上げました．他の手法としてモータへかける電圧を上げる　　が挙げられますが、コンデンサの交換等が必要となるため、改良が容易なref電圧を上げる選択をしました．
  

- IMUの搭載
  
    　加減速走行をするにはロボットの角度を取得する必要があるため，ジャイロセンサを搭載しました．偶然手持ちにあったMPU6050を使用しています．
  
    <p align="center">
      <img src="https://github.com/MasA-23/2023_RoboTracer/assets/147514546/0492ced1-3b90-49bc-9984-d6cbd6b88eaa" width="500px">
    </p>




  走行中の角速度をグラフにすると，以下のようになります．

<p align="center">
　<img src="https://github.com/MasA-23/2023_RoboTracer/assets/147514546/624c51fc-5e0c-4b81-ba9d-a0cc6703ef79" width="800px">
</p>


  一定範囲外の値を正しく取得できていないことが分かります．これはジャイロのフルスケールレンジが関係しています．MPU6050の初期フルスケールレンジは±250°となっているため，以下のようにして±2000°に設定します．

  ```Swift
  
  #define MPU6050_ADDRESS 0x68
  
  uint8_t leg[] = {0x1B, 0x18};
  i2c_write_blocking(gyro_i2c, MPU6050_ADDRESS,leg, sizeof(leg), false );
  
  ```



  改めてグラフを作ると，値を正しく取得できている事が分かります．
 
<p align="center">
<img src="https://github.com/MasA-23/2023_RoboTracer/assets/147514546/64335dca-c771-4c69-a1c2-abb5698ec233" width="800px">
</p>
  
- CPU基盤の製作

   　標準機のCPU基盤はサイズが大きいため，ラインセンサとの干渉がありました．また，ADコンバータやジャイロセンサの搭載に対応させるため，CPU基盤を新たに製作しました．<p align="center">
　<img src="https://github.com/MasA-23/2023_RoboTracer/assets/147514546/f866006d-cce5-4cd9-96a5-14833bb76c3b" width="500px">
</p>

- シャーシの製作

    　上記の改良に対応したシャーシを，3Dプリンタで製作しました．

- タイヤ幅
  
  　標準機のタイヤ幅8mmは，重量700gに対して薄すぎたため，グリップ力が足りず180°のR10でスリップしていました．そのためタイヤ幅を厚くするパーツを製作しました．スポークに摩擦で固定しています．
  
## 6.制御方法

  PD制御を用いてラインへの追従をしています．PD制御を行うには偏差eを求める必要があります．ラインセンサのアナログ値を左から L5，L4，L3，L2，L1，R1，R2…R5 とし，センサのアナログ値には距離が離れたセンサほど重みをつけるため，定数 k1～k5 をかけます．




<img src="https://latex.codecogs.com/svg.image?&space;e=(L5K5&plus;L4K4&plus;L3K3&plus;L2K2&plus;L1K1)-" title=" e=(L5K5+L4K4+L3K3+L2K2+L1K1)-" /><img src="https://latex.codecogs.com/svg.image?(R5K5&plus;R4K4&plus;R3K3&plus;R2K2&plus;R1K1)" title="(R5K5+R4K4+R3K3+R2K2+R1K1)" />


PD制御により制御量Controlを算出します．

<img src="https://latex.codecogs.com/svg.image?Control(t)=K_{P}e(t)&plus;K_{D}e\dot{}(t)" title="Control(t)=K_{P}e(t)+K_{D}e\dot{}(t)" />


速度Vに制御量を与えてVrとvlを算出します。



 ```Swift
  encoder = TIMX -> CNT;
  encoder = (encoder - 32767);
  
  speed = ((297 * M_PI) / 1146.9) * encoder;
  
  TIMX -> CNT = 32767;
  ```


## 7.ゴール判断

　単純にゴールセンサが反応した時にゴール判断をしてしまうと，クロスでもゴールセンサが反応してしまいます．そのため，クロスではゴール判断をしないという処理が必要となります．ゴールセンサがクロスに反応する前にラインセンサがクロスにかかるので，ライセンサを使ってクロスの判断ができそうです．両端のラインセンサが反応した時にフラグを立て，フラグが立っている時にゴールセンサが反応したら無視すればクロス問題は解決できそうです．


## 8.ジャイロセンサを用いた角度の算出

ロボットの角度は、角速度を積分する事で求められます。積分には様々な方法がありますが、計算での誤差を少なくするため、台形則を用います。面積を台形で近似するやつです。


𝜽𝒕=𝜽𝒕+ 𝝎𝒕+𝝎𝒕−𝟏 ∆𝒕Τ𝟐 

∆𝒕:サンプリング周期[ms]，𝝎𝒕:t秒の角速度[deg


一応これでも角度の算出はできますが、オフセットによるドリフトが発生します。センサを1分間静止させた時の角度のずれを以下に示します

平均すると約5°のずれが生じることが分かりました。ドリフトを補正するため、センサのキャリブレーションを行います。静止時に角速度の平均値と


𝜽𝒕 = 𝜽𝒕 + 𝝎𝒕 − オフセット補正値 + 𝝎𝒕−𝟏 ∆𝒕Τ𝟐 − ドリフト補正値
オフセット補正値:静止時に取得した角速度の平均値 ドリフト補正値:一定時間ジャイロセンサを静止させ， 最後に取得した角速度をサンプリング周期当たりの補正値に変換したもの

## 9.マッピング
　加減速走行を行うには，再現性のある走行とコースの記憶が必要となります．そのため走行経路を2次元座標にプロットし，再現性の確認とコースの記憶をできるようにしました．加減速走行をするだけなら，区間距離と角速度情報があればわざわざコースのプロットをする必要がありません．しかし，まだ先の話ですがショートカット走行を行う際に役立つと考えたので先行開発しました．

  Δt秒間でのロボットの移動を以下のように仮定します。
  
  不要なものを取り除くと、以下の図が得られます。

ステッピングモータを使用しているため、まずは1ステップ当たりに進む距離kを求めます。

k =

Δtで進む距離Δlを求めます。

Δl=

次にΔtでのロボットの回転Δθを求めます。

Δθ




## 10.加減速走行

[参考にさせていただいたサイト](https://github.com/raspberrypi/pico-examples/blob/master/i2c/mpu6050_i2c/mpu6050_i2c.c)

[参考にさせていただいたサイト](https://qiita.com/jamjam/items/6d49f9200d809b4a1d72)
